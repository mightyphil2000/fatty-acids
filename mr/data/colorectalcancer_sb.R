setwd("C:/Users/stephenb/Dropbox (Cambridge University)/People/Fatima Batool")

fads_ld  = read.table("fattyacids_mvmr/fads_r_matrix_ukb.ld", header=FALSE, stringsAsFactors=FALSE)
dim(fads_ld)
fads_frq  = read.table("fattyacids_mvmr/fads_r_matrix_ukb.frq", header=TRUE, stringsAsFactors=FALSE)
dim(fads_frq)
str(Dat)
table(Dat)


D5D <- Dat[Dat$trait=="AA:DGLA / D5D",]
D6D <- Dat[Dat$trait=="GLA:LA / D6D",]
outcome <- Dat[Dat$trait=="Colorectal cancer",]

## Get common variants in three datasets
commonvariants <- Reduce(intersect, list(D5D$marker,
                             D6D$marker, 
                             outcome$marker))
length(commonvariants)

## sort common variants
cv <- commonvariants [order(commonvariants)]
## Extract data for these common variants only. Note this will also give sorted data 
D5D <- D5D[D5D$marker%in%cv, ] #D5D sorting is different than following two.
D6D <- D6D[D6D$marker%in%cv, ]
outcome <- outcome[outcome$marker%in%cv, ] 
## writing cv on a file

write.csv2(cv, "fattyacids_mvmr/cvfads.csv", row.names=FALSE)
## Correlation
dim(fads_ld)
length(fads_frq$SNP)

rownames(fads_ld) <- colnames(fads_ld) <-  fads_frq$SNP
dim(fads_ld)
length(cv%in%fads_frq$SNP)
cv.cor.index <- which(cv%in%fads_frq$SNP)
fads_ld_966 <- fads_ld[cv.cor.index,cv.cor.index]
dim(fads_ld_966)
class(fads_ld_966)
## Preparing input 
bx1 <- D5D$beta
bx2 <- D6D$beta
by <- outcome$beta
sey <- outcome$se
bx <- cbind(bx1, bx2)
sex <- cbind(D5D$se, D6D$se)
cormat <- as.matrix(fads_ld_966)
p <- 996
#calling
source("fattyacids_mvmr/main_real.R")
source("fattyacids_mvmr/main_real_call.R")

## variant pruning for ivw
count = 0
loopscounter=0
rowindex <- colindex <- numeric(966)
indi <- 1
for(i in c(2:dim(fads_ld_966)[1])){ # from 2 to the number of rows
  for(j in c(1:(i-1))) {
    if(abs(fads_ld_966[i, j]) > 0.70) {
      count=count+1
      rowindex[indi] <- i
      colindex[indi] <- j
      cat("i=", i, "/n")
      cat("j=", j, "/n")
      indi = indi+1
    }
    loopscounter <- loopscounter+1
  }
}
loopscounter
count
length(rowindex)
length(colindex)
966-length(unique(colindex))  #194 remaining variants
ind <-   rep(1:966)
newind <- ind[- unique(colindex)]
length(newind) #194

## check the new correlation matrix has no cor>0.95
newcor <- fads_ld_966[newind, newind]
dim(newcor)
class(newcor)
newcor <- as.matrix(newcor)
#new betas and se
bxprune <- 
sexprune <-
byprune <-
syprune <- 
##
## apply ivw method
#IVW
ivw_out <- ivw(newcor, bx, sex, by, sey)



## Applying verena's method ##
## there are two variants only
library(MRChallenge2019)
colnames(bx) = c("AA:DGLA", "GLA:LA ")
rf = colnames(bx)

## create an object of class mvMRInput 
ces_input=new("mvMRInput", betaX = bx, betaY = as.matrix(by), snps=cv, exposure=rf, outcome = "colorectal cancer")   

## run MR-BMA                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
ces_output=summarymvMR_SSS(ces_input,kmin=1,kmax=12, prior_prob=0.1, max_iter=100000)
ces_output
##Model averaged causal effect BMAve_Estimate






 